name: Trigger Snapshot build to Firebase

on:
  repository_dispatch:
    types:
      - snapshot-build

permissions:
  id-token: write
  contents: read

env:
  VERSION_NAME: ${{ github.event.client_payload.version_name }}
  RELEASE_NOTES: ${{ github.event.client_payload.release_notes }}

jobs:
  build-ipa:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Update SPM package version
        run: |
          echo "Updating Rokt-Widget package version to $VERSION_NAME"
          # Update the version requirement in project.pbxproj
          PBXPROJ="$(find . -name 'project.pbxproj' -path '*/*.xcodeproj/*' | head -n1)"
          # Update minimumVersion for Rokt-Widget package
          /usr/bin/sed -i "" -E "s/(minimumVersion = )([0-9.]+)(.*Rokt-Widget)/\\1${VERSION_NAME}\\3/g" "$PBXPROJ" || \
          /usr/bin/sed -i "" -E "s/(Rokt-Widget.*minimumVersion = )([0-9.]+)/\\1${VERSION_NAME}/g" "$PBXPROJ"

      - name: Update Xcode version
        run: |
          set -euo pipefail
          : "${VERSION_NAME:?Missing VERSION_NAME}"
          BUILD_NUMBER="${GITHUB_RUN_NUMBER:?Missing GITHUB_RUN_NUMBER}"
      
          PBXPROJ="$(find . -name 'project.pbxproj' -path '*/*.xcodeproj/*' | head -n1)"
          /usr/bin/sed -i "" -E "s/(MARKETING_VERSION *= *)[^;]+/\\1${VERSION_NAME}/g" "$PBXPROJ"
          /usr/bin/sed -i "" -E "s/(CURRENT_PROJECT_VERSION *= *)[^;]+/\\1${BUILD_NUMBER}/g" "$PBXPROJ"
    
      - name: Build IPA
        uses: ./.github/actions/build-ipa
        with:
            certificate_p12_base64: ${{ secrets.MPARTICLE_ENTERPRISE_CERTIFICATE_P12_BASE64 }}
            certificate_password: ${{ secrets.MPARTICLE_ENTERPRISE_CERTIFICATE_PASSPHRASE }}
            provisioning_profile_base64: ${{ secrets.MPARTICLE_ENTERPRISE_PROVISIONING_PROFILE_BASE64 }}
  
      - name: Upload IPA
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
            name: release-ipa
            path: build/RoktDemo.ipa

  publish-build-to-firebase:
    runs-on: macos-15
    needs: build-ipa

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download IPA artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: release-ipa
          path: .

      - name: Upload IPA
        uses: ./.github/actions/upload-ipa
        with:
            ipa_path: RoktDemo.ipa
            service_account: ${{ secrets.SERVICE_ACCOUNT }}
            workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
            firebase_app_id: ${{ secrets.FIREBASE_APP_ID }}
            testing_groups: ${{ secrets.TESTING_GROUPS }}
            release_notes: ${{ env.RELEASE_NOTES }}